(function(){var Dom=YAHOO.util.Dom,Event=YAHOO.util.Event;var $html=Alfresco.util.encodeHTML,$date=function $date(date,format){return Alfresco.util.formatDate(Alfresco.util.fromISO8601(date),format)};Alfresco.ConsoleTagManagement=function TagManagement_constructor(htmlId){Alfresco.ConsoleTagManagement.superclass.constructor.call(this,"Alfresco.ConsoleTagManagement",htmlId,["button","container","datasource","datatable","paginator","history","animation"]);return this};YAHOO.extend(Alfresco.ConsoleTagManagement,Alfresco.component.Base,{options:{pageSize:15},searchTerm:"",resultsCount:0,currentPage:1,onReady:function ConsoleTagManagement_onReady(){this._setupDataTable();this.widgets.searchButton=Alfresco.util.createYUIButton(this,"search-button",this.onSearchClick);var queryInput=Dom.get(this.id+"-search-text");this.widgets.enterListener=new YAHOO.util.KeyListener(queryInput,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:this.onSearchClick,scope:this,correctScope:true},"keydown").enable();queryInput.value=this.searchTerm;this._performSearch({searchTerm:this.searchTerm})},_setupDataTable:function ConsoleTagManagement_setupDataTable(){var me=this;var renderCellTagInfo=function ConsoleTagManagement_onReady_renderCellTagInfo(elCell,oRecord,oColumn,oData){var tagName=oRecord.getData().name;var messageDesc='<span><a class="theme-color-1" target="_blank" href="'+Alfresco.constants.URL_PAGECONTEXT+'repository#filter=tag|'+encodeURIComponent(tagName)+'&page=1"><b>'+$html(tagName)+'</b></a></span>';elCell.innerHTML=messageDesc};var renderCellTagOwner=function ConsoleTagManagement_onReady_renderCellTagOwner(elCell,oRecord,oColumn,oData){var tagOwner=oRecord.getData().modifier;var messageDesc='<span><a class="theme-color-1" target="_blank" href="'+Alfresco.constants.URL_PAGECONTEXT+'user/'+encodeURIComponent(tagOwner)+'/profile">'+$html(tagOwner)+'</a></span>';elCell.innerHTML=messageDesc};var renderCellModificationDate=function ConsoleTagManagement_onReady_renderCellModificationDate(elCell,oRecord,oColumn,oData){var modificationDate=oRecord.getData().modified;var messageDesc='<span class="theme-color-1">'+$date(modificationDate,"dd mmm yyyy HH:MM")+'</span>';elCell.innerHTML=messageDesc};var renderCellActions=function ConsoleTagManagement_onReady_renderCellActions(elCell,oRecord,oColumn,oData){var tag=oRecord.getData();var actions="",editLink,deleteLink,index=oRecord._nCount+0;actions+='<a id="'+me.id+'-edit-link-'+index+'" href="#"  class="edit-tag" title="'+me.msg("title.editTag")+'"></a>';actions+='<a id="'+me.id+'-delete-link-'+index+'" href="#" class="delete-tag" title="'+me.msg("title.deleteTag")+'"></a><span>';elCell.innerHTML+=actions;deleteLink=Dom.getChildrenBy(elCell,function(el){return el.id===me.id+"-delete-link-"+index})[0];editLink=Dom.getChildrenBy(elCell,function(el){return el.id===me.id+"-edit-link-"+index})[0];Event.addListener(deleteLink,'click',function(){me.onActionDelete(tag.name)},deleteLink,false);Event.addListener(editLink,'click',function(){me.onActionEdit(tag.name)},editLink,false)};var tagSearchResultsURI=Alfresco.constants.PROXY_URI_RELATIVE+"api/search-tags?selectableType=cm:category&aspect=cm:taggable";this.widgets.dataSource=new YAHOO.util.DataSource(tagSearchResultsURI);this.widgets.dataSource.responseType=YAHOO.util.DataSource.TYPE_JSON;this.widgets.dataSource.connXhrMode="queueRequests";this.widgets.dataSource.responseSchema={resultsList:"data.items",fields:["name","modifier","modified"]};this.widgets.paginator=new YAHOO.widget.Paginator({containers:this.id+"-paginator",rowsPerPage:this.options.pageSize,initialPage:1,template:this.msg("pagination.template"),pageReportTemplate:this.msg("pagination.template.page-report"),previousPageLinkLabel:this.msg("pagination.previousPageLinkLabel"),nextPageLinkLabel:this.msg("pagination.nextPageLinkLabel")});var columnDefinitions=[{key:"name",label:me.msg("title.tagName"),sortable:false,formatter:renderCellTagInfo,width:120},{key:"modifiedBy",label:me.msg("title.modifiedBy"),sortable:false,formatter:renderCellTagOwner,width:150},{key:"modifiedOn",label:me.msg("title.modifiedOn"),sortable:false,formatter:renderCellModificationDate,width:150},{key:"action",label:me.msg("title.actions"),sortable:false,formatter:renderCellActions,width:35}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-tags",columnDefinitions,this.widgets.dataSource,{renderLoopSize:Alfresco.util.RENDERLOOPSIZE,initialLoad:false,paginator:this.widgets.paginator,MSG_LOADING:this.msg("loading-tags"),MSG_EMPTY:this.msg("no-tag-found")});this.widgets.dataTable.doBeforeLoadData=function Search_doBeforeLoadData(sRequest,oResponse,oPayload){if(oResponse.error){try{var response=YAHOO.lang.JSON.parse(oResponse.responseText);me.widgets.dataTable.set("MSG_ERROR",response.message)}catch(e){me._setDefaultDataTableErrors(me.widgets.dataTable)}}else if(oResponse.results){me.widgets.dataTable.set("MSG_EMPTY","");me.hasMoreResults=(oResponse.results.length>me.options.maxSearchResults);if(me.hasMoreResults){oResponse.results=oResponse.results.slice(0,me.options.maxSearchResults)}me.resultsCount=oResponse.results.length;if(me.resultsCount>0){Dom.removeClass(me.id+"-paginator","hidden");Dom.removeClass(me.id+"-tags-list-bar-bottom","hidden");Dom.removeClass(me.id+"-tags","hidden");Dom.addClass(me.id+"-tags-list-info","hidden")}else{Dom.addClass(me.id+"-paginator","hidden");Dom.addClass(me.id+"-tags-list-bar-bottom","hidden");Dom.addClass(me.id+"-tags","hidden");Dom.get(me.id+'-tags-list-info').innerHTML=me.msg("no-tag-found");Dom.removeClass(me.id+"-tags-list-info","hidden")}}return true};this.widgets.paginator.subscribe("changeRequest",function(state,scope){scope.currentPage=state.page;scope.widgets.paginator.setState(state)},this);this.widgets.dataTable.subscribe("renderEvent",function(){me.widgets.paginator.setState({page:me.currentPage,totalRecords:me.resultsCount});me.widgets.paginator.render()})},onSearchClick:function ConsoleTagManagement_onSearchClick(e,args){var searchTermElem=Dom.get(this.id+"-search-text");this._performSearch({searchTerm:searchTermElem.value})},_performSearch:function ConsoleTagManagement__performSearch(args){if(args.searchTerm!=undefined){this.searchTerm=YAHOO.lang.trim(args.searchTerm)}this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength());this.widgets.dataTable.set("MSG_EMPTY","");this.widgets.dataTable.render();function successHandler(sRequest,oResponse,oPayload){this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,sRequest,oResponse,oPayload);this.resultsCount=oResponse.results.length;Dom.get(this.id+"-search-text").focus()}function failureHandler(sRequest,oResponse){if(oResponse.status==401){window.location.reload()}else{try{var response=YAHOO.lang.JSON.parse(oResponse.responseText);this.widgets.dataTable.set("MSG_ERROR",response.message);this.widgets.dataTable.showTableMessage(response.message,YAHOO.widget.DataTable.CLASS_ERROR)}catch(e){this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.render()}}}if(this.searchTerm==""||this.searchTerm=="*"){this.widgets.dataSource.sendRequest("",{success:successHandler,failure:failureHandler,scope:this})}else{this.widgets.dataSource.sendRequest("&searchTerm="+encodeURIComponent(this.searchTerm),{success:successHandler,failure:failureHandler,scope:this})}},onActionEdit:function ConsoleTagManagement_onActionEdit(tagName){var actionUrl=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/edit-tag/{store_type}/{store_id}/{tagName}",{store_type:"workspace",store_id:"SpacesStore",tagName:encodeURIComponent(tagName)});var doSetupFormsValidation=function sA_oACT_doSetupFormsValidation(p_form){p_form.addValidation(this.id+"-edit-tag-name",Alfresco.forms.validation.mandatory,null,"keyup");p_form.setShowSubmitStateDynamically(true,false)};var editTag=new Alfresco.module.SimpleDialog(this.id+"-edit-tag");editTag.setOptions({width:"30em",templateUrl:YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"components/admin/edit-tag?htmlid={id}&tagName={tagName}",{id:this.id+"-edit-tag",tagName:encodeURIComponent(tagName)}),actionUrl:actionUrl,destroyOnHide:true,doSetupFormsValidation:{fn:doSetupFormsValidation,scope:this},onSuccess:{fn:function dlA_onActionEditTag_success(response){if(response.json.result==true){Alfresco.util.PopupManager.displayMessage({text:this.msg(response.json.msg)});this._performSearch({searchTerm:this.searchTerm})}else{Alfresco.util.PopupManager.displayPrompt({title:this.msg("title.error"),text:this.msg(response.json.msg),buttons:[{text:this.msg("button.close"),handler:function onEditTag_failure_close(){this.destroy()}}]})}},scope:this},onFailure:{fn:function onActionEditTag_failure(response){if(response.serverResponse.status===400&&response.json!=undefined&&response.json.result===false){Alfresco.util.PopupManager.displayMessage({text:this.msg(response.json.msg)})}else{Alfresco.util.PopupManager.displayMessage({text:this.msg("message.edit.failure")})}},scope:this}}).show()},onActionDelete:function ConsoleTagManagement_onActionDelete(tagName){var me=this;Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.confirm.delete.title"),text:this.msg("message.confirm.delete",tagName),buttons:[{text:this.msg("button.delete"),handler:function dlA_onActionDelete_delete(){this.destroy();me._onActionDeleteConfirm(tagName)}},{text:this.msg("button.cancel"),handler:function dlA_onActionDelete_cancel(){this.destroy()},isDefault:true}]})},_onActionDeleteConfirm:function ConsoleTagManagement_onActionDeleteConfirm(tagName){Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.DELETE,url:YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/delete-tag/{store_type}/{store_id}/{tagName}",{store_type:"workspace",store_id:"SpacesStore",tagName:encodeURIComponent(tagName)}),successCallback:{fn:function onDelete_success(response){Alfresco.util.PopupManager.displayMessage({text:this.msg(response.json.msg)});if(response.json.result==true){this._performSearch({searchTerm:this.searchTerm})}},scope:this},failureMessage:this.msg("message.delete.failure")})}})})();